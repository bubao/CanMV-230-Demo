# 在立创庐山派上运行 YOLOv8 物体检测系统

最近入手了一块立创庐山派，想做测试一下视觉检测的效果。但是奈何我只买了板子，没买屏幕，CanMV-ide 又没有 mac 版本。找了一圈资料后，直接脱离 ide 通过`ampy`等工具与庐山派通信，并连接 Wi-Fi 使用 MQTT 通信，把识别结果发到服务端。

## 前提条件

在开始之前，请确保你已经完成以下准备工作：

**安装 Python 3.x**：你可以从 [Python 官网](https://www.python.org/downloads/) 下载并安装 Python 3.x。

**配置虚拟环境**：

```shell
cd project # 假设这是项目目录
python3.9 -m venv venv
source venv/bin/activate
```

**安装必要的工具**：

```bash
pip install adafruit-ampy mpremote
sudo apt-get install screen  # 对于 Debian/Ubuntu 系统
brew install screen          # 对于 macOS 系统
```

## 连接庐山派 CanMV-K230

首先，通过 USB 线将庐山派 CanMV-K230 连接到电脑。

```shell
# lsusb
Bus 001 Device 009: ID 1209:abd1 1209 CanMV  Serial: 001000000
```

使用以下命令查看挂载位置：

```shell
# ls /dev/tty* | grep '001000000'
/dev/tty.usbmodem0010000001
```

在项目文件夹下创建 `.ampy` 文件，并加入以下内容：

```txt
AMPY_PORT=/dev/tty.usbmodem0010000001
AMPY_BAUD=115200
AMPY_DELAY=0.5
```

使用 `ampy` 测试一下是否能正常连接：

```bash
ampy ls /sdcard
```

如果能正常显示`sdcard`分区下的文件和文件夹则说明能正常连接。

## 修改配置

```bash
cp .config.example.json .config.json
```

配置文件包含 WiFi、YOLO、MQTT 和 NTP 的配置信息。根据自己实际情况修改配置

```json
{
  "wifi": {
    "enabled": true, // 是否开启 wifi
    "networks": [
      {
        "enabled": true,
        "ssid": "A",
        "password": "passwd1"
      },
      {
        "enabled": true,
        "ssid": "B",
        "password": "passwd1"
      }
    ]
  },
  "yolo": {
    "enabled": true, // 是否开启 yolo
    "task_type": "detect",
    "mode": "image",
    "labels": [
      "person",
      "bicycle",
      "car",
      "motorcycle",
      // ...existing labels...
      "toothbrush"
    ],
    "rgb888p_size": [1920, 1080],
    "kmodel_path": "/sdcard/examples/kmodel/yolov8n_320.kmodel",
    "model_input_size": [320, 320],
    "display_size": [1920, 1080],
    "display_mode": "hdmi",
    "conf_thresh": 0.5,
    "nms_thresh": 0.45,
    "mask_thresh": 0.5,
    "max_boxes_num": 50,
    "debug_mode": 0
  },
  "mqtt": {
    "enabled": true, // 是否开启 mqtt
    "broker": "192.168.0.3",
    "port": 1883,
    "topic_detection": "/yolo/detection",
    "client_id": "CanMV_k230_yolo_001",
    "username": "who",
    "password": "me"
  },
  "ntptime": {
    "enabled": true, // 是否开启对时
    "ntp_delta": 3155644800,
    "host": "ntp6.aliyun.com"
  }
}
```

主函数执行以下步骤：

1. 加载配置。
2. 检查所需的配置（WiFi、YOLO、MQTT）是否存在并启用，这个项目里必须开启这三项。
3. 测试 WiFi 连接。
4. 如果启用了 NTP 时间同步，则同步时间。NTP 不启动也不会影响后续的操作。
5. 初始化 MQTT 客户端并连接到 MQTT 代理。
6. 初始化 YOLO 模型和处理管道。
7. 每秒处理帧，进行目标检测，并将结果发送到 MQTT 代理。
8. 处理异常并释放掉处理管道、 MQTT 和 YOLO 的资源。

## 上传文件到庐山派 CanMV-K230

使用 ampy 工具可以方便地将文件上传到庐山派 CanMV-K230。使用以下命令将文件上传到板子上：

```bash
ampy put <文件名> [目标路径]
```

同样地，可以使用 ampy 工具从板子上下载文件：

```bash
ampy get <文件名> > <本地文件名>
```

## 使用 mip 安装第三方包

目前庐山派 CanMV-K230 固件并没有支持 mip，需要自己手动安装 `mpremote`，再执行以下命令：

```bash
pip install mpremote
mpremote connect /dev/tty.usbmodem0010000001 mip --target="/sdcard/libs" install mip
```

## 使用 screen 查看日志

可以使用 screen 工具连接到庐山派 CanMV-K230 并查看日志输出：

```bash
screen -S K230 /dev/cu.usbmodem0010000001 115200
```

要退出 screen 会话，可以按 `Ctrl+A`，然后按 `K`，最后按 `Y` 确认退出。

> 每次进入都会 soft reset，可以按 `Ctrl+D` 手动 soft reset，如果正在运行，也可以用 `Ctrl+C` 终止运行

## 添加依赖

立创庐山派固件缺少 `ntptime`，需要使用`mpremote`手动安装：

```bash
mpremote connect /dev/tty.usbmodem0010000001 mip --target="/sdcard/libs" install ntptime
```

## 项目运行

只要把准备好的文件都拷贝到庐山派上，项目就能正常启动了。只要板子能正常连接到 Wi-Fi 和 MQTT，就能从同样连接到 MQTT 服务器并订阅了对应 topic 的 MQTTX 上看到输出。

```json
// Topic: /yolo/detectionQoS: 0
[{"fps": 20.0, "confidence": 0.5664063, "bbox": [896.0, 2.0, 1277.0, 701.0], "label": "person"}]

// Topic: /yolo/detectionQoS: 0
[{"fps": 18.51852, "confidence": 0.8510742, "bbox": [261.0, 5.0, 1911.0, 1042.0], "label": "person"}]
```
